<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡«å¯«æ”¶ä»¶è³‡æ–™ - Cyndi éŸ“åœ‹ç«¥è£ä»£è³¼</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .btn-primary {
            background-color: #FF69B4;
            border-color: #FF69B4;
        }
        
        .btn-primary:hover {
            background-color: #FF1493;
            border-color: #FF1493;
        }
        
        .order-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .price-tag {
            color: #FF69B4;
            font-weight: bold;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <div class="text-center mb-4">
            <h3><i class="fas fa-clipboard-list text-primary"></i> å¡«å¯«æ”¶ä»¶è³‡æ–™</h3>
            <p class="text-muted">è«‹å®Œæ•´å¡«å¯«ä»¥ä¸‹è³‡æ–™ï¼Œä»¥ä¾¿æˆ‘å€‘ç‚ºæ‚¨é…é€å•†å“</p>
        </div>

        <!-- è¨‚å–®æ‘˜è¦ -->
        <div class="order-summary" id="order-summary">
            <h5><i class="fas fa-shopping-cart"></i> è¨‚å–®æ‘˜è¦</h5>
            <div id="order-items"></div>
            <hr>
            <div class="d-flex justify-content-between">
                <strong>ç¸½è¨ˆï¼š</strong>
                <span class="price-tag">NT$ <span id="total-amount">0</span></span>
            </div>
        </div>

        <!-- æ”¶ä»¶è³‡æ–™è¡¨å–® -->
        <div class="form-container">
            <form id="order-form">
                <div class="mb-3">
                    <label for="customer-name" class="form-label">
                        <i class="fas fa-user"></i> æ”¶ä»¶äººå§“å *
                    </label>
                    <input type="text" class="form-control" id="customer-name" required>
                </div>

                <div class="mb-3">
                    <label for="customer-phone" class="form-label">
                        <i class="fas fa-phone"></i> è¯çµ¡é›»è©± *
                    </label>
                    <input type="tel" class="form-control" id="customer-phone" required>
                </div>

                <div class="mb-3">
                    <label for="customer-address" class="form-label">
                        <i class="fas fa-map-marker-alt"></i> æ”¶ä»¶åœ°å€ *
                    </label>
                    <textarea class="form-control" id="customer-address" rows="3" required></textarea>
                </div>

                <div class="mb-3">
                    <label for="shipping-method" class="form-label">
                        <i class="fas fa-truck"></i> é…é€æ–¹å¼
                    </label>
                    <select class="form-select" id="shipping-method">
                        <option value="å®…é…åˆ°åºœ">ğŸšš å®…é…åˆ°åºœ (+60å…ƒ)</option>
                        <option value="7-11å–è²¨">ğŸª 7-11 å–è²¨ (+60å…ƒ)</option>
                        <option value="å…¨å®¶å–è²¨">ğŸª å…¨å®¶å–è²¨ (+60å…ƒ)</option>
                        <option value="éƒµå±€å¯„é€">ğŸ“¦ éƒµå±€å¯„é€ (+80å…ƒ)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="payment-method" class="form-label">
                        <i class="fas fa-credit-card"></i> ä»˜æ¬¾æ–¹å¼
                    </label>
                    <select class="form-select" id="payment-method">
                        <option value="éŠ€è¡Œè½‰å¸³">ğŸ¦ éŠ€è¡Œè½‰å¸³</option>
                        <option value="LINE Pay">ğŸ“± LINE Pay</option>
                        <option value="è²¨åˆ°ä»˜æ¬¾">ğŸ’° è²¨åˆ°ä»˜æ¬¾ (+30å…ƒ)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="order-note" class="form-label">
                        <i class="fas fa-sticky-note"></i> å‚™è¨» (é¸å¡«)
                    </label>
                    <textarea class="form-control" id="order-note" rows="2" 
                              placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤èªªæ˜..."></textarea>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-check-circle"></i> ç¢ºèªé€å‡ºè¨‚å–®
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> è¿”å›è³¼ç‰©è»Š
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">è™•ç†ä¸­...</span>
                    </div>
                    <h5>è™•ç†è¨‚å–®ä¸­...</h5>
                    <p class="text-muted">è«‹ç¨å€™ï¼Œæ­£åœ¨ç‚ºæ‚¨å»ºç«‹è¨‚å–®</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class OrderApp {
            constructor() {
                this.userId = null;
                this.profile = null;
                this.cart = [];
                this.apiBaseUrl = '/api';
                
                this.init();
            }
            
            async init() {
                try {
                    await liff.init({
                        liffId: process.env.LIFF_ID || 'YOUR_LIFF_ID'
                    });
                    
                    if (liff.isLoggedIn()) {
                        this.profile = await liff.getProfile();
                        this.userId = this.profile.userId;
                        
                        // é å¡«ç”¨æˆ¶è³‡æ–™
                        document.getElementById('customer-name').value = this.profile.displayName || '';
                        
                        // è¼‰å…¥è³¼ç‰©è»Š
                        await this.loadCart();
                        
                        // è¨­å®šè¡¨å–®æäº¤äº‹ä»¶
                        document.getElementById('order-form').addEventListener('submit', (e) => {
                            e.preventDefault();
                            this.submitOrder();
                        });
                        
                    } else {
                        liff.login();
                    }
                    
                } catch (error) {
                    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                    alert('æ‡‰ç”¨åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
            }
            
            async loadCart() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/cart/${this.userId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.cart = result.data.items;
                        this.renderOrderSummary(result.data.total);
                    } else {
                        alert('è¼‰å…¥è³¼ç‰©è»Šå¤±æ•—');
                        this.goBack();
                    }
                    
                } catch (error) {
                    console.error('è¼‰å…¥è³¼ç‰©è»ŠéŒ¯èª¤:', error);
                    alert('è¼‰å…¥è³¼ç‰©è»Šæ™‚ç™¼ç”ŸéŒ¯èª¤');
                }
            }
            
            renderOrderSummary(total) {
                const container = document.getElementById('order-items');
                
                if (this.cart.length === 0) {
                    alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
                    this.goBack();
                    return;
                }
                
                const itemsHtml = this.cart.map(item => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${item.productName}</strong>
                            <br>
                            <small class="text-muted">å°ºå¯¸ï¼š${item.size} | æ•¸é‡ï¼š${item.quantity}</small>
                        </div>
                        <span class="price-tag">NT$ ${item.price * item.quantity}</span>
                    </div>
                `).join('');
                
                container.innerHTML = itemsHtml;
                document.getElementById('total-amount').textContent = total;
            }
            
            async submitOrder() {
                try {
                    // é¡¯ç¤ºè¼‰å…¥ä¸­
                    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
                    loadingModal.show();
                    
                    // æ”¶é›†è¡¨å–®è³‡æ–™
                    const customerInfo = {
                        name: document.getElementById('customer-name').value.trim(),
                        phone: document.getElementById('customer-phone').value.trim(),
                        address: document.getElementById('customer-address').value.trim(),
                        shippingMethod: document.getElementById('shipping-method').value,
                        paymentMethod: document.getElementById('payment-method').value,
                        note: document.getElementById('order-note').value.trim()
                    };
                    
                    // é©—è­‰å¿…è¦æ¬„ä½
                    if (!customerInfo.name || !customerInfo.phone || !customerInfo.address) {
                        loadingModal.hide();
                        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                        return;
                    }
                    
                    // é€å‡ºè¨‚å–®
                    const response = await fetch(`${this.apiBaseUrl}/orders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.userId,
                            customerInfo: customerInfo
                        })
                    });
                    
                    const result = await response.json();
                    
                    loadingModal.hide();
                    
                    if (result.success) {
                        // è¨‚å–®æˆåŠŸ
                        alert(`âœ… è¨‚å–®å»ºç«‹æˆåŠŸï¼\nè¨‚å–®ç·¨è™Ÿï¼š${result.data.orderNumber}\n\næˆ‘å€‘å°‡ç›¡å¿«ç‚ºæ‚¨è™•ç†è¨‚å–®`);
                        
                        // é—œé–‰ LIFF
                        liff.closeWindow();
                        
                    } else {
                        alert('è¨‚å–®å»ºç«‹å¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                    
                } catch (error) {
                    console.error('é€å‡ºè¨‚å–®éŒ¯èª¤:', error);
                    document.querySelector('#loadingModal').style.display = 'none';
                    alert('é€å‡ºè¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°å˜—è©¦');
                }
            }
            
            goBack() {
                if (liff.isApiAvailable('closeWindow')) {
                    liff.closeWindow();
                } else {
                    history.back();
                }
            }
        }
        
        function goBack() {
            if (window.orderApp) {
                window.orderApp.goBack();
            }
        }
        
        // åˆå§‹åŒ–æ‡‰ç”¨
        window.orderApp = new OrderApp();
    </script>
</body>
</html> 